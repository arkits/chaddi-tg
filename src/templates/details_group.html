{% extends "base.html" %}
{% block title %}Group Details{% endblock %}
{% block head %} {{ super() }} {% endblock %}
{% block content %}
<div class="container-lg">
  <nav>
    <ul class="breadcrumb">
      <li class="breadcrumb-item">details</li>
      <li class="breadcrumb-item">
        <a href="/groups">groups</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{group.group_id}}
      </li>
    </ul>
  </nav>

  {% if response_message %}
  <div class="alert {{response_message.alert_type}}" role="alert">
    <h4 class="alert-heading">{{response_message.title}}</h4>
    {{response_message.message}}
  </div>
  {% endif %}

  <div class="page-header">
    <h1>{{group.name}}</h1>
    <p class="text-muted">Group ID: {{group.group_id}}</p>
  </div>

  <div class="card">
    <div class="card-body">
      <h3 class="card-title">Group Information</h3>
      <table class="table">
        <tbody>
          <tr>
            <th class="text-right">ID:</th>
            <td class="text-left"><span class="badge badge-info">{{group.group_id}}</span></td>
          </tr>
          <tr>
            <th class="text-right">Created:</th>
            <td class="text-left">{{group.created}}</td>
          </tr>
          <tr>
            <th class="text-right">Updated:</th>
            <td class="text-left">{{group.updated}}</td>
          </tr>
          <tr>
            <th class="text-right">Members:</th>
            <td class="text-left"><span class="badge badge-primary">{{groupmembers|length}}</span></td>
          </tr>
          <tr>
            <th class="text-right">Messages:</th>
            <td class="text-left">
              <span class="badge badge-success">{{message_count}}</span>
              <a href="/messenger?group_id={{group.group_id}}" class="btn btn-primary btn-sm" role="button"
                style="margin-left: 1rem;">View Messages</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h3 class="card-title">Send Message</h3>
      <form method="POST" action="/api/bot/send_message">
        <input type="hidden" name="group_id" value="{{group.group_id}}" />
        <div class="form-group">
          <label for="message-input">Message Text</label>
          <input id="message-input" class="form-control" type="text" name="message" value=""
            placeholder="Enter your message here..." />
        </div>
        <button class="btn btn-primary" type="submit">Send Message to Group</button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h3 class="card-title">Command Settings</h3>
      <div class="custom-switch mb-10">
        <input type="checkbox" class="command-toggle" id="check-ask" value="ask" {% if
          group.metadata.get('enabled_commands') and 'ask' in group.metadata.get('enabled_commands') %}checked{% endif
          %}>
        <label for="check-ask">Enable /ask command</label>
      </div>
      <div class="custom-switch mb-10">
        <input type="checkbox" class="setting-toggle" id="check-gm" value="good_morning_enabled" {% if
          group.metadata.get('good_morning_enabled') %}checked{% endif %}>
        <label for="check-gm">Enable Good Morning Greeting</label>
      </div>
    </div>
  </div>

  <script>
    const updateMetadata = (metadata) => {
      const groupId = "{{group.group_id}}";

      fetch('/api/group/metadata', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          group_id: groupId,
          metadata: JSON.stringify(metadata)
        })
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
        })
        .catch((error) => {
          console.error('Error:', error);
          alert('Failed to update settings');
          location.reload(); // Reload to reset state on error
        });
    };

    document.querySelectorAll('.command-toggle').forEach(item => {
      item.addEventListener('change', event => {
        const command = event.target.value;
        const isChecked = event.target.checked;

        let metadata = {{ group.metadata| tojson_pretty | safe
      }};
    if (!metadata.enabled_commands) {
      metadata.enabled_commands = [];
    }

    if (isChecked) {
      if (!metadata.enabled_commands.includes(command)) {
        metadata.enabled_commands.push(command);
      }
    } else {
      metadata.enabled_commands = metadata.enabled_commands.filter(c => c !== command);
    }

    updateMetadata(metadata);
      })
    })

    document.querySelectorAll('.setting-toggle').forEach(item => {
      item.addEventListener('change', event => {
        const setting = event.target.value;
        const isChecked = event.target.checked;

        let metadata = {{ group.metadata| tojson_pretty | safe
      }};
    metadata[setting] = isChecked;

    updateMetadata(metadata);
      })
    })
  </script>

  <div class="card">
    <div class="card-body">
      <h3 class="card-title">Group Members ({{groupmembers|length}})</h3>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Name</th>
              <th>Rokda</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for groupmember in groupmembers %}
            <tr>
              <td><span class="badge badge-info">{{groupmember.bakchod.tg_id}}</span></td>
              <td><strong>{{groupmember.bakchod.username}}</strong></td>
              <td>{{groupmember.bakchod.pretty_name}}</td>
              <td><span class="badge badge-success">{{groupmember.bakchod.rokda}}</span></td>
              <td>{{groupmember.bakchod.lastseen}}</td>
              <td>
                <a href="/details/bakchod?tg_id={{groupmember.bakchod.tg_id}}" class="btn btn-primary btn-sm"
                  role="button">View Details</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}